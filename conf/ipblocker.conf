# Lines that begin with a comment (#) are ignored
# Think of each line as a a key:value setup as such: key[sub-key][sub-sub-key][sub-sub-sub-key]=value
# Duplicates are allowed.  The last one wins!
# This is being used by perl so let's keep a few thigns in mind:
#   1. False value is 0.  Period.  That's it.  0 (zero) is false.  Everything else is true.
#   2. Regular expressions are PERL regular expressions.  So they are case sensitive and use PERL regular expressions.
#   3. Unless otherwise noted, sorting is regular perl sorting.  So 1, 10, 11 come before 2, 20, 21, etc.


### Global settings 
# The global settings are used for all log files unless overridden or combined by the individual log file settings.

# The a different iptables command
#   If this is not set, then the default is `which iptables`
#   A simpe check is done to verify that the iptables command exists and is executable.
#   A good method is to use a sudo command to run iptables as a different user.
#   This also means seting up sudo to allow the user to run iptables as a different user in passwordless mode.
#   Steps to do this:
#     1.  Create a user to run the iptables command.  For example, iptablesuser
#     2.  Create a group to run the iptables command.  For example, iptablesgroup
#     3.  Add the iptablesuser to the iptablesgroup
#     4.  Add the following line to the /etc/sudoers file:
#           iptablesuser ALL=(ALL) NOPASSWD: /sbin/iptables
#     5.  Set the iptables command to the following:
#           iptables=sudo -u iptablesuser /sbin/iptables
# iptables=/usr/sbin/iptables_some_other_location
iptables=sudo /sbin/iptables

# The location of the log4perl configuration file if different than default location of /etc/ipblocker/log4perl.conf
# log4perlconf=/some/other/place/log4perl.conf

# The log level to use.  
# This will override the log level in the log4perl configuration file.
# I encourage setting this in the the log4perl configuration file but it is here if you need it.
# I put this in here because the sample calling has the ability to set the log level so might as well have it here too.
# This may be one of the following:
#  DEBUG INFO WARN ERROR FATAL TRACE
#  FYI:  I did not use trace anywhere in the code so it is not really an option that will give you anything extra 
#        than just using DEBUG.
# loglevel=DEBUG

# The location of the lock file
#   If this is not set, then the default is /var/run/iptables.run
#   The lock file is used to prevent multiple instances of this script from running at the same time.
# lockfile=/some/other/directory/iptables.run

# The number of seconds to wait to check to see if there are entries in the queue to process
#   If this is not set, then the default is 2 seconds
#   Prevents the script from going CPU crazy and checking the queue as fast as possible.
#   You can set this to 0 to check the queue as fast as possible but I would not recommend it.
# Once a queue entry is found then the queue is checked continuously until the queue is empty.
# I see very little utility in having this set to 0 or even less than 1 second.
# queuechecktime=4

# Whether or not the entire log file is read each time.  If set to 0 (false), then we only read from the end of the 
#   last read (or the beginning if it is the first read or if the log file has been allegedly rotated)
#   Reading from last read is faster, but if the log file is rotated AND the log file grows larger than the last read, then
#       we may miss some entries.
#   If this setting does not exist, then it is assumed to be 0.
#   For most situations, this should be set to 0.
#   If you rotate your log files frequently AND get a lot of traffic, then you may want to set this to 1.
readentirefile	    = 0

# This is how many times a log file will be reviewed.
# This is a global value and can be set for each log file individually.
#  (Very bad naming of a variable, sorry)
#   If this is not set, then the default is 9007199254740991
cycles=10

# This is how many seconds to sleep between checking a log file.
# This is a global value and can be set for each log file individually.
#  If this is not set, then the default is 0.5 seconds
#  This gets a bit complex to decide but here goes:
#  If you are always reviewing the entire log file, then this value is rather important.
#     Reviewing the entire log file means that you are not using the "readentirefile" setting.
cyclesleep=2

# Process nice level on the OS
nice=15

PRODMODE=1  # Set this to a perl false value (0) to run in test mode.
            # Default is test mode. (meaning  PRODMODE=0 is the default)
            # Test mode will NOT run any iptable command but will log what it would have been done.

globalchains=INPUT,OUTPUT,FORWARD   # Default is INPUT,OUTPUT,FORWARD
                                    # These are the chains which all rules will act upon.
                                    # Not for sure why you would change this but it is here if you need it.

# Deny list of IPs:  deny these IPs, almost always.  The allowdeny value takes precedence when order of allowdeny
# is set.  See below.
# The denylist is added to the individual log file denylist.
denylist[01]							= 165.232.121.37
denylist[02]							= 165.232.121.36

# Allow list of IPs:  allow these IPs, almost always.  The allowdeny value takes precedence when order of allowdeny
# is set.  See below.
# The allowlist is added to the individual log file allowlist.
allowlist[00]							= 75.87.147.162
allowlist[01]							= 64.250.56.204
allowlist[02]							= 192.73.248.201
allowlist[03]							= 199.38.182.248
allowlist[04]							= 158.69.195.66
allowlist[05]							= 185.34.216.102
allowlist[06]							= 192.73.241.233
allowlist[07]							= 192.73.241.56
allowlist[08]							= 198.251.81.67
allowlist[09]							= 198.50.163.67
allowlist[10]							= 199.195.248.92
allowlist[11]							= 204.109.63.3
allowlist[12]							= 208.86.227.242
allowlist[13]							= 209.177.157.147
allowlist[14]							= 81.4.124.103
allowlist[15]							= 91.189.91.38
allowlist[16]							= 185.34.3.136
allowlist[17]							= 20.245.57.59
allowlist[18]							= 3.3.3.3

# Individual log files settings for this value take precedence over the general settings here
#   Allow,Deny means that the allowlist is processed first and then the denylist is processed.
#      Items in the allowlist will be allowed even if they are in the denylist.
#   Deny,Allow means that the denylist is processed first and then the allowlist is processed.
#      Items in the denylist will be denied even if they are in the allowlist.
#  I would not change this unless you know what you are doing.  You have the potential to lock yourself out of your
#  own system.
allowdeny                               = Allow,Deny


### Not yet implemented....
# Finds the IPs of each interface and adds them to the allow list.
#  Some logs have the IP of the interface in the log file.
#  This is a perl true/false value.  If it is set to 0 (false) then the IPs of each interface will be added to 
#  the allowlist.
#  If you keep allowdeny set  to Allow,Deny then this will keep you from blocking your own IPs.
#    Or, at least that is the idea!  This is totally based on Net::Ifconfig::Wrapper so... do some testing
#    to make sure that it is working as expected.
#  I encourage leaving this as 0 (false) but it is here if you need it.  
#  The default value, if not set, is 0 (false)
# ignoreinterfaceips=0

### End of Global settings



# Settings for each log file from here down

### The authlog settings:
# The "logs_to_review" hash is a list of log files to review.  Each log file has a unique name.  The name is used 
#   to reference the log file in other parts of the configuration file.
#   In the exampple of "authlog", the string "authlog" could be any alphanumeric string.  It is just used for reference.
# Auth log file
#   The "load" value is a perl true/false value.  If it is set to 1 (true) then the log file will be reviewed.  
#   If it is set to 0 (false) then the log file will not be reviewed.
logs_to_review[authlog][load] 				    = 1
#   The "file" value is the location of the log file to review.
logs_to_review[authlog][file]				    = /var/log/auth.log
# Cycles and cyclessleep
#   See description above for global settings.  Same applies here but for this log file only.
logs_to_review[authlog][cycles]                 = 10
#   The number of seconds to sleep between cycles.  Can be partial seconds.  So 0.5 is a half second.
logs_to_review[authlog][cyclesleep]             = 1.5
# Blocking port number.  This is the port number(s) that will be blocked in the firewall when an offending IP is found in
# the log file.
#   If the port is not set, then the default is all ports.
logs_to_review[authlog][port][01]               = 22
logs_to_review[authlog][port][02]               = 21
logs_to_review[authlog][port][03]               = 23
# Blocking protocol.  This is the protocol(s) that will be blocked in the firewall.
#   If the protocol is not set, then the default is tcp.
logs_to_review[authlog][protocol][01]           = tcp
logs_to_review[authlog][protocol][02]           = udp
# allowdeny
#  This is the order preference for whitelisted and blacklisted IPs.
#  If the order is set to "Deny,Allow" then blacklisted IPs will ALWAYS be blocked (even if they are in the whitelisted hash)!
#  If the order is set to "Allow,Deny" then whitelisted IPs will ALWAYS be allowed (even if they are in the blacklisted hash)!
#  If the order is not set or is set incorrectly then the default is "Allow,Deny"
#  When using authlog, I would reccomend setting the order to "Allow,Deny" so that whitelisted IPs are always allowed for ssh.
#  The order is case insensitive.
logs_to_review[authlog][allowdeny]          = Allow,Deny
# Whether or not the entire log file is read each time.  If set to 0 (false), then we only read from the end of the 
#   last read (or the beginning if it is the first read or if the log file has been allegedly rotated)
#   Reading from last read is faster, but if the log file is rotated AND the log file grows larger than the last read, then
#       we may miss some entries.
#   If this setting does not exist, then it is assumed to be 0.
#   For most situations, this should be set to 0.
#   If you rotate your log files frequently AND get a lot of traffic, then you may want to set this to 1.
logs_to_review[authlog][readentirefile]	    = 0
# List of IPs to allow just for this log file
logs_to_review[authlog][allowlist][01]     =  1.1.1.1
logs_to_review[authlog][allowlist][02]     =  2.2.2.2
logs_to_review[authlog][allowlist][03]     =  3.3.3.3
logs_to_review[authlog][allowlist][04]     =  4.4.4.4
logs_to_review[authlog][allowlist][05]     =  23.116.91.65
logs_to_review[authlog][allowlist][05]     =  23.116.91.66
logs_to_review[authlog][allowlist][06]     =  23.116.91.67
logs_to_review[authlog][allowlist][07]     =  23.116.91.68
# List of IPs to block just for this log file
logs_to_review[authlog][denylist][01]      =  5.5.5.5
logs_to_review[authlog][denylist][02]      =  6.6.6.6
# Each regular expression must have a unique value.  This is just typically indexed as 01, 02, 03, 04, etc.  But it can 
#   be any Alphanumeric
#   The index is sorted in simple perl sort.  So 1, 10, 11 come before 2, 20, 21, etc.
#   Also, lowercase will come before uppercase.  So a, b, c, A, B, C.
#   The sorting may matter because the regular expressions are applied in order.
#   Regular expressions are case insensitive and use perl regular expressions.
logs_to_review[authlog][regexpdeny][01]  		= Failed password for root from
logs_to_review[authlog][regexpdeny][02]  		= Failed password for invalid user
logs_to_review[authlog][regexpdeny][03]  		= Did not receive identification string from
logs_to_review[authlog][regexpdeny][04]  		= not allowed because listed in DenyUsers
# Authlog has a special value of allowed usernames
logs_to_review[authlog][allowedusername][01] = gardner
logs_to_review[authlog][allowedusername][02] = jiggerboy
# Authlog has a special value of not-allowed usernames
logs_to_review[authlog][deniedusername][01] 	= root



#### Now... an example without comments

### The maillog settings:
logs_to_review[maillog][load] 				= 1
logs_to_review[maillog][file]				= /var/log/mail.log
logs_to_review[maillog][cycles]             = 3
logs_to_review[maillog][cyclesleep]         = 2.25
logs_to_review[maillog][order]              = Allow,Deny 
logs_to_review[maillog][regexpdeny][1] 			= Relay access denied,Illegal address syntax from
logs_to_review[maillog][regexpdeny][2]			= SASL LOGIN authentication failed
logs_to_review[maillog][regexpdeny][3]			= SSL_accept error from
logs_to_review[maillog][regexpdeny][4]			= lost connection after AUTH from unknown
logs_to_review[maillog][regexpdeny][5]			= 503 5.5.1 Error: authentication # not enabled
logs_to_review[maillog][regexpdeny][6]			= disconnect from.* commands=0\/0
logs_to_review[maillog][regexpdeny][7]			= non-SMTP command from unknown
logs_to_review[maillog][regexpdeny][8]			= connect to.*:25: Connection refused


# usernames=gardner,jiggerboy,nkunkee,4x4chuckie,gemalto,openwave,emlodz02
# maillog=/var/log/mail.log
# maillogbadregexps=
# # 
# # Authorization Log file
# authlog=/var/log/auth.log
# authlogbadregexps=Failed password for root from,Failed password for invalid user,Did not receive identification string from,not allowed because listed in DenyUsers
# usernames=gardner,jiggerboy,nkunkee,4x4chuckie,gemalto,openwave,emlodz02
# #
# # Named (Bind) Query Log
# querylog=/var/log/named/query.log
# querylogbadregexps=isc.org,VERSION.BIND
# #
# # FQDNS
# allowedfqdns=localhost
# blockedfqdns=177-152-183-174.primatecmt.com.br
# 
# blockedips=165.232.121.37
# 
# # Access Log
# accesslog=/var/log/apache2/roundcube_access.log,/var/log/apache2/access.log
# #accesslogregexps=badactor,Random String Error
# accesslogregexps=druid
# 
